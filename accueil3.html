
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="style.css"/> <!--mise en forme-->
	<title>Calculations</title> <!-- onglet -->
</head>

<header>
	<div class="intro">
	CALCULATIONS
	
	</div>
</header>

<body>
	<!--
	<div class="intro">
		Ajouter une personne : <input id="name" type="text" name="name" value="nom"> 
		<input type="button" name="addLineTab" value="Ajouter personne" onclick="addPersonne()">
		<input type="button" name="start_reset" value="Start/Reset" onclick="start_reset()">
	</div>
	-->

	<div>
		</br></br>
		<input type="button" name="addRow" value="ajouter une nouvelle ligne" onclick="addRow()">
		<input type="button" name="addExtraPerson" value="add an extra person" onclick="addExtraPerson()">
		<input id="nameGris" type="text" name="nameExtraPerson" value="add an extra person" onfocus="changeColor()" > 
		</br></br>
	</div>
	<TABLE id="tab" BORDER="1"> 
		<CAPTION> Tableau de dépenses </CAPTION> 
		<THEAD>
			<TR> 
			 <TH> Depense de </TH> 
			 <TH> Montant </TH> 
			</TR>
		</THEAD>
		<TBODY>
			
			
		</TBODY>
	</TABLE> 


	<!--
	<div>	
		</br></br>
		<input type="button" name="parcoursTab" value="parcours Tab" onclick="parcoursTab()">
		<input type="button" name="deleteDuplicate" value="deleteDuplicate" onclick="deleteDuplicate()">
	</div>
	-->

	<div id="reset">	
		<input type="button" name="reset" value="Restart All" onclick="reset()">
	</div>
	<div>	
		</br></br>
		<input type="button" name="calculateResult" value="SHOW RESULTS" onclick="calculateResult()">
	</div>

</body>

<!-- -------------------------------------------------------------------------------------------->

<script>

/* declaration des variables */
var theRowNumber = 1;
var tabCouple;
var newTabCouple; 


/* Recuperation du tableau */
var url = window.location.search;
var tabStr = url.substring(url.lastIndexOf("=")+1);
//alert("start:"+tabStr+":finshed");
var tabPerson = tabStr.split(",");

/* start */
for(var i=0; i<tabPerson.length; i++){
	addPersonne(tabPerson[i]);
}
addRow()
/* fin start */



function calculateResult(){
	parcoursTab();
	deleteDuplicate();
	afficheResult();
}


/* construit tous les couples dans tabCouple */
function parcoursTab(){ 
	tabCouple = [];
	/*
	var tab = document.getElementById("tab");
	var tags = tab.getElementsByTagName("input");
	alert("mon premier tag : "+tags[0].innerHTML);
	*/
	
	var arrayLignes = document.getElementById("tab").rows; //on récupère les lignes du tableau
	var longueur = arrayLignes.length;//on peut donc appliquer la propriété length


	for(var i=1; i<longueur; i++){//on peut directement définir la variable i dans la boucle

		var largeur = arrayLignes[i].cells.length; // arrayColonnes.length;

		//alert("longueur : "+longueur+" - i : "+i);
		var idBuyer = document.getElementById(i.toString()+"0").value;
		var amount = parseFloat(document.getElementById(i.toString()+"1").value);
		var tabBeneficiary = [];

		for(var j=2; j<largeur; j++){
			var element = document.getElementById(i.toString()+j.toString());
    			if(element.checked == true){
				tabBeneficiary.push(j-2);
			}
		}
		var amountPerson = amount/tabBeneficiary.length; //float

		for(var k=0; k<tabBeneficiary.length; k++){
			if(idBuyer != tabBeneficiary[k]){
				var unCouple = [idBuyer,amountPerson,tabBeneficiary[k]];
				tabCouple.push(unCouple);
			}
		}
	}
	//alert("tabCouple : "+tabCouple[0]);
	afficheTabCouple(tabCouple, "tab couple : ");
}

function afficheTabCouple(tab, str){
	var txt = "";
	for(var i=0; i<tab.length; i++){
		txt += tab[i] + "\n";
	}
	alert(str+txt);
}
function deleteDuplicate(){
	newTabCouple = [];

	for(var i=0; i<tabCouple.length; i++){
		var idBuyer = tabCouple[i][0];
		var amount = tabCouple[i][1];
		var idBenef = tabCouple[i][2];
		var alreadySeen = false;

		for(var k=0; k<newTabCouple.length; k++){
			if((idBuyer == newTabCouple[k][0]) && (idBenef == newTabCouple[k][2])){
				alreadySeen = true;
			}
			if((idBuyer == newTabCouple[k][2]) && (idBenef == newTabCouple[k][0])){
				alreadySeen = true;
			}
		}
		if(!alreadySeen){
			for(var j=i+1; j<tabCouple.length; j++){
			
				if((idBuyer == tabCouple[j][0]) && (idBenef == tabCouple[j][2])){ //on a un doublon
					amount += tabCouple[j][1];
				}
				if((idBuyer == tabCouple[j][2]) && (idBenef == tabCouple[j][0])){ //on a un doublon
					amount -= tabCouple[j][1];
				}
			}
			
			if(amount < 0){ 
				amount = amount*(-1); 
				var x = idBuyer;
				idBuyer = idBenef;
				idBenef = x;
			}
			var newCouple = [idBuyer,amount,idBenef];
			newTabCouple.push(newCouple);
		}
		
	}
	afficheTabCouple(newTabCouple, "newTabCouple : ");
}
function optimisation(){
	var over = false;
	var i = 0;
	var j = 0;
	var k = 0;
	//on travail sur newTabCouple
	while(i < newTabCouple.length){

		//couple à traiter 
		var idBuyer = newTabCouple[i][0];
		var amount = newTabCouple[i][1];
		var idBen = newTabCouple[i][2];
		var found = false;
		j = i+1;
		var toFind;
		var compl;
		var config = "";

		//find 3 couples to reduce
		while(!found && j < newTabCouple.length){
			found=true;
			if(idBuyer == newTabCouple[j][0]){
				config="ac";
				toFind = newTabCouple[j][2];
				compl = idBen;
			}
			else if (idBuyer == newTabCouple[j][2]){
				config = "ca";
				toFind = newTabCouple[j][0];
				compl = idBen;
			}
			else if (idBen == newTabCouple[j][0]){
				config = "bc";
				toFind = newTabCouple[j][2];
				compl = idBuyer;
			}
			else if (idBen == newTabCouple[j][2]){
				config = "cb";
				toFind = newTabCouple[j][0];
				compl = idBuyer;

			}
			else {  found = false; 
				j++;
			}


			if(found){ //on trouve
				k = j+1;
				var found2 = false;
				while(!found2 && k < newTabCouple.length){
					if( (toFind == newTabCouple[k][0] || toFind == newTabCouple[k][2]) && 
						(compl == newTabCouple[k][0] || compl == newTabCouple[k][2]) ){
					 found2 = true;	
					 //ACTION!!!!!!
					 var couple1 = newTabCouple[i]; // a b
					 var couple2 = newTabCouple[j];
					 var couple3 = newTabCouple[k];
					 newTabCouple.splice(k,1);
					 switch (config) {
					    case "ac": // couple2 : a c
						if(couple3[0] == idBen){ // couple3 : b c
							coupl1[1] -= couple3[1]; 
							coupl2[1] += couple3[1];
						}
						if(couple3[2] == idBen){ // couple3 : c b
							coupl2[1] -= couple3[1]; 
							coupl1[1] += couple3[1];
						}
						break;
					    case "ca": // couple2 : c a
						couple2 = inverserCouple(couple2); //mnt couple2 : a c
						if(couple3[0] == idBen){ // couple3 : b c
							coupl1[1] -= couple3[1]; 
							coupl2[1] += couple3[1];
						}
						if(couple3[2] == idBen){ // couple3 : c b
							coupl2[1] -= couple3[1]; 
							coupl1[1] += couple3[1];
						}
						break;
					    case "bc": // couple2 : b c 
						couple2 = inverserCouple(couple2); //mnt couple2 : c b
						if(couple3[0] == idBuyer){ // couple3 : a c
							coupl1[1] += couple3[1]; 
							coupl2[1] -= couple3[1];
						}
						if(couple3[2] == idBuyer){ // couple3 : c a
							coupl1[1] -= couple3[1]; 
							coupl2[1] += couple3[1];

						}
						break;
					    case "cb": // couple2 : c b
						if(couple3[0] == idBuyer){ // couple3 : a c
							coupl1[1] += couple3[1]; 
							coupl2[1] -= couple3[1];
						}
						if(couple3[2] == idBuyer){ // couple3 : c a
							coupl1[1] -= couple3[1]; 
							coupl2[1] += couple3[1];
						}
						break;
					 } // fin switch
					 newTabCouple[i]=couple1; // a b
					 newTabCouple[j]=couple2;
					} //fin if	
					else{ 
						k++;
					}
				}//fin while3
				if(!found2){ //on est sorti du while car parcouru tout le tab -> mais pas trouvé	
				 found = false; 
				 j++;
				}
			}
		}//fin while2 : on est sorti car le found reste a true
		if(!found){//on est sorti du while car j>tab.length : on a finit pour ce i
			i++;
		}
	}//fin while1
	afficheTabCouple(newTabCouple, "OUHHHHH : ");
}


//tab.splice(0,1); remove 1 element at the place n°0
function inverserCouple(cpl){
	var a=cpl[0];
	var m=cpl[1];
	var b=cpl[2];
	cpl[0]=b;
	cpl[1]=m*(-1);
	cpl[2]=a;
	return cpl
}
function afficheResult(){
	var text = '';
	for(var k=0; k<newTabCouple.length; k++){
		text += tabPerson[newTabCouple[k][2]] + " owes : " + newTabCouple[k][1] + "€ to "+ tabPerson[newTabCouple[k][0]] + "\n";
	}
	alert(text);
}




/****************************************** EXTRA PERSON *******************************************/

function changeColor(){
	var inputName = document.getElementById("nameGris");
	inputName.id = "name"; //inputName.setAttribute("id","name");
	inputName.value = ""; //inputName.setAttribute("value","");
}

/** a faire ... */
function addExtraPerson(){
	var inputName = document.getElementById("name");
	var name = inputName.value;
	inputName.value = "add person"; //setAttribute("value","");
	inputName.id = "nameGris";

	alert(name+" ajouté");
	//var div = document.getElementById("listPerson");
	//div.innerHTML += "- "+name+" </br> ";

	//tab.push(name);
}

function addPersonne(nameAdd){
	//if (!isStarted){
		//var nameAdd = document.getElementById("name").value;
		//ajoutTab(nameAdd);

		var arrayLines = document.getElementById("tab").rows;
		var cell = arrayLines[0].insertCell(-1);
	 /*	var table = document.getElementById ("tab");
		var firstRow = table.rows[0];
		var cell = firstRow.insertCell (1); */

		cell.innerHTML += "<b>"+nameAdd+"</b>";
	
	/*else{
		alert("il n'est plus possible d'ajouter des prenom, veuillez cliquez sur reset et ajouter tout le monde avant de commencer!")
	}*/
}

/****************************************** // EXTRA PERSON *******************************************/


/******************************** done ************************************/

function reset(){
	//window.location = "accueil3.html";//"file:///home/entdev3/Documents/GIT/web/accueil3.html"
	location.href='accueil3.html?tabPerson='+tabPerson;
}
function addRow(){
	//if (isStarted){
		var newRow = document.getElementById("tab").insertRow(-1);

		// Add Select
		var cell0 = newRow.insertCell(0);
		cell0.innerHTML += createTextSelect(theRowNumber);

		//Add Input Amount
		var cell1 = newRow.insertCell(1);
		var id = theRowNumber + "1";
		cell1.innerHTML = '<input id="'+id+'" type="text" value="00.00">';

		// Add checkbox for persons
		for(i=0; i<tabPerson.length; i++){
			id = theRowNumber + (i+2).toString();
			var cell = newRow.insertCell(i+2);
			cell.innerHTML = '<input id="'+id+'" type="checkbox" >';
		}
		theRowNumber++;
	
	/*else{
		alert("veuillez cliquer demarrer l'appli 'start/reset' avant d'ajouter des lignes");
	}*/
}
/* depends of "addRow()" */
function createTextSelect(rowNumber){

	//'<select name="pays" id="pays"><option value="emiel">emiel</option><option value="kirsty">kirsty</option></select>'
	var nameSelect = 'select'+rowNumber;
	var id = rowNumber + "0";
	var text = '<select id="'+id+'" name="'+nameSelect+'" id="'+nameSelect+'">';
	for(i=0; i<tabPerson.length; i++){
		text += '<option value="'+i+'">'+tabPerson[i]+'</option>';
	}
	text += '</select>';
	return text;
}
</script>

</html>
